# ============================================================
# OpenClaw NexusMind - Docker Compose
# Deploiement complet pour VPS (Hostinger / Ubuntu)
#
# Usage:
#   cp .env.example .env          # Configurer les cles API
#   docker compose up -d          # Lancer en arriere-plan
#   docker compose logs -f app    # Suivre les logs
#   docker compose down           # Arreter
# ============================================================

services:

  # ── OpenClaw Application ─────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openclaw
    restart: unless-stopped
    command: gateway

    env_file:
      - .env

    environment:
      - OPENCLAW_GATEWAY__HOST=0.0.0.0
      - OPENCLAW_GATEWAY__PORT=18789
      - TZ=${TZ:-Europe/Paris}

    volumes:
      - openclaw_memory:/data/memory
      - openclaw_config:/data/config
      - openclaw_logs:/data/logs
      - openclaw_skills:/data/skills
      - openclaw_traces:/data/traces
      - sandbox_tmp:/tmp/openclaw-sandbox
      - /var/run/docker.sock:/var/run/docker.sock  # For sandbox container management

    ports:
      - "${OPENCLAW_PORT:-18789}:18789"

    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3

    networks:
      - openclaw_net

    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-1G}
          cpus: "${CPU_LIMIT:-1.0}"
        reservations:
          memory: 128M

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ── Nginx Reverse Proxy ──────────────────────────────────────
  nginx:
    build:
      context: ./docker/nginx
      dockerfile: Dockerfile
    container_name: openclaw-nginx
    restart: unless-stopped
    depends_on:
      app:
        condition: service_healthy

    volumes:
      - nginx_cache:/var/cache/nginx
      - certbot_www:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro

    ports:
      - "80:80"
      - "443:443"

    networks:
      - openclaw_net

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ── Certbot (Let's Encrypt SSL) ─────────────────────────────
  certbot:
    image: certbot/certbot
    container_name: openclaw-certbot
    volumes:
      - certbot_www:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    # Renouvellement auto : lancer periodiquement
    # docker compose run --rm certbot renew
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do sleep 12h & wait $${!}; certbot renew; done'"

    networks:
      - openclaw_net

  # ── ChromaDB (Vector Database for RAG) ──────────────────────
  chromadb:
    image: chromadb/chroma:latest
    container_name: openclaw-chromadb
    restart: unless-stopped

    volumes:
      - chromadb_data:/chroma/chroma

    environment:
      - ANONYMIZED_TELEMETRY=false
      - IS_PERSISTENT=TRUE

    networks:
      - openclaw_net

    expose:
      - "8000"

    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    profiles:
      - full  # Only start with: docker compose --profile full up -d

  # ── SearXNG (Private Meta Search Engine) ────────────────────
  searxng:
    image: searxng/searxng:latest
    container_name: openclaw-searxng
    restart: unless-stopped

    environment:
      - SEARXNG_BASE_URL=http://searxng:8080
      - SEARXNG_SECRET=${SEARXNG_SECRET:-openclaw-searxng-secret-key}

    volumes:
      - searxng_data:/etc/searxng

    networks:
      - openclaw_net

    # Internal only - accessible via app container
    expose:
      - "8080"

    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # ── Watchtower (mise a jour auto des containers) ─────────────
  watchtower:
    image: containrrr/watchtower
    container_name: openclaw-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=86400  # 24h
      - WATCHTOWER_LABEL_ENABLE=true
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

    profiles:
      - auto-update  # Activer avec: docker compose --profile auto-update up -d

# ── Volumes ──────────────────────────────────────────────────
volumes:
  openclaw_memory:
    driver: local
  openclaw_config:
    driver: local
  openclaw_logs:
    driver: local
  openclaw_skills:
    driver: local
  openclaw_traces:
    driver: local
  nginx_cache:
    driver: local
  certbot_www:
    driver: local
  certbot_certs:
    driver: local
  searxng_data:
    driver: local
  chromadb_data:
    driver: local
  sandbox_tmp:
    driver: local

# ── Network ──────────────────────────────────────────────────
networks:
  openclaw_net:
    driver: bridge
